-#  Copyright (c) 2025, German Contingent for the Worldscoutjamboree 2027. This file is part of
-#  hitobito_wsjrdp_2027 and licensed under the Affero General Public License version 3
-#  or later. See the COPYING file at the top-level directory or at
-#  https://github.com/hitobito/hitobito_wsjrdp_2027.

- title(t('groups.statistics.title'))

.container.my-4
  .row.mb-4#stats-cards
    .col-md-2.col-6.mb-3
      .stat-card.card-total.loading
        %div.label Gesamt
        %div.value= @count[:total]
    .col-md-2.col-6.mb-3
      .stat-card.loading
        %div.label YP
        %div.value= @count[:yp]
    .col-md-2.col-6.mb-3
      .stat-card.loading
        %div.label UL
        %div.value= @count[:ul]
    .col-md-2.col-6.mb-3
      .stat-card.loading
        %div.label IST
        %div.value= @count[:ist]
    .col-md-2.col-6.mb-3
      .stat-card.loading
        %div.label CMT
        %div.value= @count[:cmt]

  .row.mb-4
    .col-12
      %p
        %strong Personen in Status:
      #chart-status.chart-container.loading

  .row.mb-4
    .col-12
      %p
        %strong Angemeldete Personen - (im Anmeldeportal mindestens registriert):
      #chart-registration-date.chart-container.loading

  .row.mb-4
    .col-12
      #chart-role.chart-container.loading

  .row.mb-4
    .col-12
      %p
        %strong Anmeldung von TN abgeschlossen - ("Upload vollständig", "Dokumente in Überprüfung durch CMT" oder "Dokumente vollständig überprüft"):
      #chart-registration-completed.chart-container.loading

  .row.mb-4
    .col-12
      %p
        %strong Anmeldung von TN abgeschlossen - (nach Datum Upload vollständig):
      #chart-completion-date.chart-container.loading

  .row.mb-4
    .col-12
      %p
        %strong Bestätigt durch CMT:
      #chart-registration-verified.chart-container.loading

= javascript_include_tag 'hitobito_wsjrdp_2027/application'

:javascript
  (function () {
    const groupId = "#{@group.id}";

    fetch(`/groups/${groupId}/statistics/data`)
      .then(response => response.json())
      .then(data => {
        renderColumnChart("chart-status", data.people_by_status, {library: {title: "Personen nach Status"}});
        renderLineChart("chart-registration-date", data.people_by_registration_date, {library: {title: "Registrierung über Zeit"}});
        renderColumnChart("chart-role", data.people_by_role, {library: {title: "Personen nach Rolle"}});
        renderColumnChart("chart-registration-completed", data.registration_completed_people_by_role, {library: {title: "Registrierung abgeschlossen"}});
        renderLineChart("chart-completion-date", data.people_by_completion_date, {library: {title: "Dokumenten-Upload über Zeit"}});
        renderColumnChart("chart-registration-verified", data.registration_verified_people_by_role, {library: {title: "Bestätigte Anmeldungen"}});
      })
      .catch(error => {
        console.error("Fehler beim Laden der Statistikdaten:", error);
        document.querySelectorAll(".chart-container").forEach(el => {
          el.classList.remove("loading");
          el.textContent = "Fehler beim Laden der Daten.";
        });
      });
  })();

  function renderColumnChart(containerId, data, options = {}) {
    const container = document.getElementById(containerId);
    if (!container) return;

    container.classList.remove("loading");
    new Chartkick.ColumnChart(container, data, options);
  }

  function renderLineChart(containerId, data, options = {}) {
    const container = document.getElementById(containerId);
    if (!container) return;

    container.classList.remove("loading");
    new Chartkick.LineChart(container, data, options);
  }
